# Architecture

MTGO Metagame Deck Builder is a wxPython desktop application for Windows that provides metagame research, deck building, opponent tracking, and collection management for Magic: The Gathering Online players.

## Generating Diagrams

Update architecture diagrams automatically:

```bash
python scripts/generate_architecture_diagram.py
python scripts/generate_dependency_diagram.py
```

The architecture diagram is generated by analyzing the codebase structure via AST parsing. The dependency diagrams use pydeps to visualize module imports.

## Architecture Overview

```mermaid
graph TB
    subgraph "Entry Point"
        MAIN[main.py<br/>MetagameWxApp]
    end

    subgraph "Controllers Layer"
        AC[AppController<br/>Central State & Coordination]
    end

    subgraph "UI Layer (wxPython Widgets)"
        AF[AppFrame<br/>Main Window]
        DRP[DeckResearchPanel<br/>Archetype Browser]
        DBP[DeckBuilderPanel<br/>Deck Editor]
        CTP[CardTablePanel<br/>Card Lists]
        CIP[CardInspectorPanel<br/>Card Details]
        SGP[SideboardGuidePanel<br/>Matchup Guides]
        RP[RadarPanel<br/>Metagame Analysis]
        ODS[MTGOpponentDeckSpy<br/>Overlay Tracker]
    end

    subgraph "Services Layer"
        DS[DeckService<br/>Parse/Validate/Average]
        CS[CollectionService<br/>MTGO Collection]
        SS[SearchService<br/>Card Search]
        IS[ImageService<br/>Card Images]
        StS[StoreService<br/>Persistence]
        RS[RadarService<br/>Metagame Stats]
        STS[StateService<br/>App State]
        MBS[MTGOBackgroundService<br/>MTGO Data Fetch]
    end

    subgraph "Repositories Layer"
        CR[CardRepository<br/>Card Data Access]
        DR[DeckRepository<br/>Deck Storage]
        MR[MetagameRepository<br/>Archetype Data]
    end

    subgraph "Utilities"
        CD[card_data.py<br/>MTGJson Manager]
        CI[card_images.py<br/>Image Downloader]
        AC_CLASS[archetype_classifier.py<br/>Deck Classification]
        DECK[deck.py<br/>Deck Parser]
        MBC[mtgo_bridge_client.py<br/>Bridge Client]
    end

    subgraph "Web Scrapers"
        MTG_GF[mtggoldfish.py<br/>MTGGoldfish Scraper]
    end

    subgraph "External Bridge"
        BRIDGE[MTGOBridge.exe<br/>.NET 9.0 + MTGOSDK]
    end

    subgraph "External Data Sources"
        SCRYFALL[Scryfall API/CDN]
        MTGJSON[MTGJson Database]
        GOLDFISH[MTGGoldfish]
        MTGO_CLIENT[MTGO Client]
    end

    MAIN --> AC
    AC --> AF
    AF --> DRP
    AF --> DBP
    AF --> CTP
    AF --> CIP
    AF --> SGP
    AF --> RP
    AC --> ODS
    AC --> DS
    AC --> CS
    AC --> SS
    AC --> IS
    AC --> StS
    AC --> RS
    AC --> STS
    AC --> MBS
    DS --> DR
    DS --> CR
    SS --> CR
    CS --> CR
    RS --> MR
    MBS --> MR
    CR --> CD
    DR --> DECK
    MR --> AC_CLASS
    IS --> CI
    CS --> MBC
    MR --> MTG_GF
    MTG_GF --> GOLDFISH
    CI --> SCRYFALL
    CD --> MTGJSON
    MBC --> BRIDGE
    BRIDGE --> MTGO_CLIENT

    classDef controller fill:#ff9999,stroke:#333,stroke-width:2px
    classDef service fill:#99ccff,stroke:#333,stroke-width:2px
    classDef repo fill:#99ff99,stroke:#333,stroke-width:2px
    classDef ui fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef util fill:#cc99ff,stroke:#333,stroke-width:2px
    classDef external fill:#ffff99,stroke:#333,stroke-width:2px

    class AC controller
    class DS,CS,SS,IS,StS,RS,STS,MBS service
    class CR,DR,MR repo
    class AF,DRP,DBP,CTP,CIP,SGP,RP,ODS ui
    class CD,CI,AC_CLASS,DECK,MBC util
    class SCRYFALL,MTGJSON,GOLDFISH,MTGO_CLIENT,BRIDGE external
```

## Layer Responsibilities

**Controllers**: Central coordination, state management, and business logic orchestration via AppController

**Services**: Business logic for decks, collections, search, images, metagame analysis, and background tasks

**Repositories**: Data access layer for cards, decks, and metagame information with caching

**UI/Widgets**: wxPython GUI components for research, building, tracking, and analysis

**Utils**: Card data management, image downloading, archetype classification, deck parsing, and MTGO bridge

**Navigators**: Web scrapers for MTGGoldfish metagame and tournament data

**External Bridge**: .NET application using MTGOSDK to communicate with MTGO client

## Data Flow

Metagame research: MTGGoldfish scraping → MetagameRepository caching → UI display
Deck building: Card search → DeckService parsing → CardTablePanel rendering
Collection sync: MTGO bridge → CollectionService → Ownership marking in UI
Card images: Scryfall bulk data + CDN → ImageService caching → Display
